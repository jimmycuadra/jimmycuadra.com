<!DOCTYPE html>
<html>
  <head>
    <title>
      How Lita.io uses the RubyGems and rubygems.org APIs |
      Jimmy Cuadra
    </title>
    <link href="/stylesheets/application-58ac5912.css" rel="stylesheet" type="text/css" />
    <link href='http://feeds.feedburner.com/jimmycuadra' rel='alternate' title='RSS' type='application/rss+xml'>
    <script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-5500916-1');ga('send', 'pageview');</script>
  </head>
  <body>
    <header class='site-header'>
      <div class='bucket'>
        <a class='title-link' href='/' title='Jimmy Cuadra'>
          <img width="75" height="75" alt="Jimmy Cuadra" class="logo" src="/images/logo-3e3e6b15.png" />
          <hgroup>
            <h1 class='main-title'>I'm Jimmy Cuadra.</h1>
            <p>I write about programming and open source software.</p>
          </hgroup>
          <div class='clear'></div>
        </a>
      </div>
    </header>
    <nav>
      <div class='bucket'>
        <ul>
          <li><a title="Writing" href="/">Writing</a></li>
          <li><a class="sub-nav" title="Writing by tags" href="/tags/">by tags</a></li>
          <li><a title="Jimmy Cuadra's Résumé" href="/resume/">Résumé</a></li>
        </ul>
      </div>
    </nav>
    <div class='content'>
      <div class='bucket'>
        <article itemscope itemtype='http://schema.org/BlogPosting'>
          <meta content='Jimmy Cuadra' itemprop='author'>
          <header>
            <h1 class='post-title' itemprop='headline'><a title="How Lita.io uses the RubyGems and rubygems.org APIs" href="/posts/how-lita-io-uses-the-rubygems-and-rubygems-org-apis/">How Lita.io uses the RubyGems and rubygems.org APIs</a></h1>
            <data itemprop='datePublished' value='2014-01-23'>January 23, 2014</data>
          </header>
          <div class='social'>
            <div class='g-plus' data-action='share' data-annotation='bubble' data-href='/posts/how-lita-io-uses-the-rubygems-and-rubygems-org-apis/'></div>
            <a class='twitter-share-button' data-count='horizontal' data-text='How Lita.io uses the RubyGems and rubygems.org APIs' data-url='/posts/how-lita-io-uses-the-rubygems-and-rubygems-org-apis/' data-via='jimmycuadra' href='https://twitter.com/share'>Tweet</a>
          </div>
          <p>Today I released a brand new website for Lita at <a href="http://www.lita.io/">lita.io</a>. While the site consists primarily of static pages for documentation, it also has a cool feature that takes advantage of a few relatively unknown things in the Ruby ecosystem. That feature is the <a href="http://www.lita.io/plugins">plugins page</a>, an automatically updating list of all Lita plugins that have been published to RubyGems.</p>
          
          <p>Previously, the only directory of Lita plugins was Lita's wiki on GitHub. When someone released a plugin, they'd have to edit the list manually. This was not ideal. It was easy to forget, and required that people knew that the wiki had such a list in the first place. To make an automatically updating list, I had to think about how I could detect Lita plugins out there on the Internet.</p>
          
          <p>I spent some time digging through the rubygems.org source code to see how I might get the information I wanted out of the API. After experimenting with a few things, I discovered an undocumented API: reverse dependencies. You can hit the endpoint <code>/api/v1/gems/GEM_NAME/reverse_dependencies.json</code> and you will get back a list of all gems that depend on the given gem. This was great! Now I had a list of names of all the gems that depend on Lita. It's pretty safe to assume those are all Lita plugins.</p>
          
          <p>This API only returns the names of the gems, however. I also wanted to display a description and the authors' names. This data could be gathered from an additional API request, but there was another piece of information I wanted that couldn't be extracted from the API.</p>
          
          <p>Lita has two types of plugins: adapters and handlers. Adapters allow Lita to connect to a particular chat service, and handlers add new functionality to the robot at runtime; they're the equivalent of Hubot's scripts. I wanted the plugins page to list the plugin type along with the name, author, and link to its page on rubygems.org. To do this, I used another lesser-known feature: RubyGems metadata.</p>
          
          <p>In RubyGems 2.0 or greater, a gem specification can include arbitrary metadata. The metadata consists of a hash assigned to the <code>metadata</code> attribute of a <code>Gem::Specification</code>. The keys and values must all be strings. In Lita 2.7.1, I updated the templates used to generate new Lita plugins so that they automatically included metadata in their gemspecs indicating which type of plugin it is. For example:</p>
          
          <pre><code class="language-ruby">Gem::Specification.new do |spec|&#x000A;  spec.metadata = { "lita_plugin_type" =&gt; "handler" }&#x000A;end&#x000A;</code></pre>
          
          <p>Because Lita requires Ruby 2.0 or greater, which comes with RubyGems 2.0, any Lita plugin can use the metadata attribute. Any plugins created before the generator update in Lita 2.7.1 can still be detected and listed on the plugins page, it just won't list their type.</p>
          
          <p>Now all I had to do was read this information from each plugin gem. Unfortunately, rubygems.org currently has no API that exposes gem metadata, so things got a little tricky. I wrote a script which called <code>gem fetch</code> to download the actual gem files for all the Lita plugins. Once downloaded, running <code>gem spec</code> on the gem file outputs a YAML representation of the gem's specification. In Ruby, loading that YAML with <code>YAML.load</code> returns a <code>Gem::Specification</code>. From there I could simply access the fields I wanted to display, including the type of plugin via <code>spec.metadata["lita_plugin_type"]</code>. This data is then persisted in Postgres. The script runs once a day to get the latest data from RubyGems.</p>
          
          <p>This process could be made much easier and less error-prone if rubygems.org added metadata to the information it exposes over its API. Nevertheless, creating the plugins page for Lita.io was a good challenge and gave me a chance to explore some of the pieces of the RubyGems ecosystem I didn't know existed.</p>
          <footer>
            <p>
              This post was tagged with <a title="Writing tagged with lita" itemprop="keywords" href="/posts/tags/lita/">lita</a> and <a title="Writing tagged with ruby" itemprop="keywords" href="/posts/tags/ruby/">ruby</a>.
            </p>
            <p>
              Find more content by <a title="Browse writing by tags" href="/tags/">browsing by tags</a>.
            </p>
          </footer>
        </article>
      </div>
    </div>
    <footer class='site-footer'>
      <div class='bucket'>
        <p>Logo by <a href="http://stephanielucido.com/" title="Stephanie Lucido">Stephanie Lucido</a>.</p>
        <small>
          &copy; 2015 Jimmy Cuadra. All rights reserved.
        </small>
      </div>
    </footer>
    <script src="/javascripts/application-f844c8db.js" type="text/javascript"></script>
    <script>
    (function() {
      var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
      po.src = 'https://apis.google.com/js/platform.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
    (function(d, t) {
      var e = d.createElement(t), s = d.getElementsByTagName(t)[0];
      e.type = 'text/javascript'; e.async = true; e.src = '//platform.twitter.com/widgets.js';
      s.parentNode.insertBefore(e, s);
    })(document, 'script');
    </script>
  </body>
</html>
